language: ruby

rvm:
  - 2.6.1
 
services:
  - sqlite

build:
  # pre_ci_boot:
  #     image_name: drydock/u14ruball
  #     image_tag: latest
  #     pull: true
  #     env: FOO=bar
  #     options: "-e HOME=/root"
  env:
    - RAILS_ENV=production
  ci:
    # - cp config/database.shippable.yml config/database.yml
    # - gem uninstall bundler -v 2.0.1
    # - gem install bundler -v 1.3.0
    # - rails db:setup
    - bundle install
    - rails db:migrate
    - rails assets:precompile
    - rspec
  post_ci:
    - docker build -t 069194799098.dkr.ecr.eu-central-1.amazonaws.com/rspec-test1:latest .
    - aws ecr get-login --no-include-email | bash
    - docker push 069194799098.dkr.ecr.eu-central-1.amazonaws.com/rspec-test1:latest

integrations:                               
  hub:
    - integrationName: aws_ecr_keys
      type: ecr

  notifications:
    - integrationName: email
      type: email
      on_success: never
      on_failure: never
      on_cancel: never
      on_pull_request: never      

    - integrationName: slackme   
      type: slack
      recipients:
        - "#docker-rails"
      on_success: always
      on_failure: always
      on_cancel: always
      on_start: always
      on_pull_request: always
